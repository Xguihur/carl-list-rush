## 经纬度需求分析

> 分析过程

1. 使用截图从 template 、dialog、save、valid 方面一步步分析，贴图代码在屏幕，在网页看效果分析会非常清晰，大致也能根据代码细节猜到功能！
2. 使用 md 在旁边记录各个模块的分析结果，梳理解决方法

> 知识总结

1. 多个不同的表单验证不需要很麻烦，有不同的属性绑定的话使用多个 el-form 即可，每个 form 绑定不同的 v-model ，rules 可以相同没问题！最后校验的时候通过 ref 获取到 form ，调用 validat 方法就可以判断是否通过验证了，很爽！
2. await this.$refs['dataItem1_eventPosOffset'].validate(); 直接 这行代码就行了，不需要啥返回值，只要不通过验证直接就是执行 rules 中设置好的 错误提示，展示在输入框中

> template 部分

1. 事件坐标
   1. 服务器拿到的是没有小数点区分的，毅哥使用了一个方法：formatCoord 方法进行了转化，内部实现可以看看，猜测只是简单地转化一下
2. 路径坐标
   1. 服务器拿到的也是没有小数点的，但是页面需要展示 半径与路径，毅哥使用了一个方法`msgHtmlPath` 进行处理，最后导出 html 文本
   2. 在组件中使用 `v-html` 进行渲染!
   3. 既然展示已经封装好了，那上传到服务器的反向格式化也封装一个方法好了

> dialog 部分

1. 事件坐标
   1. 使用了 v-model 绑定两个参数，并且通过 prop 绑定 el-form-item 的校验。
   2. 可以修改prop校验规则
2. 路径坐标
   1. 通过 v-for 循环多个 el-form-item ，但实际上还是可以绑定 prop 进行校验，v-model 绑定的也是两个经纬度的参数
   2. 可以试试通过 prop 修改校验规则

> 上传给服务器的处理

1. 在 save 方法内部的最后delete那块区域对 事件、路径 的经纬度进行格式化，可以使用一个方法进行格式化，对于路径的可能还需要使用 for 循环

> save 时的校验处理，不同的经纬度绑定不同的 prop ，让他们都通过验证才可以

1. 在 save 中看看能不能结合 el 表单的 valid 赋值给 _falg ，进行相关的验证提示即可（理论上不通过表单处会默认弹出prop绑定的提示的，message 提示通用的就好）
2. 有一些可以为空的经纬度做校验时要做 0 的排除

> 点击编辑时

1. 点击编辑时还需要做去小数点的格式化

> 标牌用同样的方法就能完成了

1. 在 template 中设置 ref 获取 form
2. 在 js 中导入 utils 的方法，格式化经纬度和经纬度校验字段
3. 因为服务器存放的是无小数点的，于是展示和回显（编辑）都需要去小数点操作（在getItem和openItem 方法都格式化一下加上小数点）
4. 对于路径经纬度而已是一个数组，遍历里面的一个个进行格式化
5. 点击保存时对经纬度进行校验，通过el-UI绑定的form校验和自己的规则进行校验。
   1. 有一个细节是不需要获取那个form的validate值，使用 async await 中断就好，如果没有成功后面的代码就不执行，只会在输入框提示用户规范格式。当然可以在await那里使用 try-catch 捕获异常
   2. 路径那个无法用el-UI的校验，于是只能自己重新改造校验的函数，用for循环遍历每一个经纬度，如果经度或者纬度任何一个不符合规则就将一个flag设置为 false。
   3. 在循环外部监听这个 flag，如果是false就直接 el-message 告诉用户规范格式
6. 验证通过后需要去掉小数点，于是找到合适的位置格式化 标牌经纬度和路径经纬度（依然需要遍历）
7. 最后测试后端返回的数据（服务端）确实是没有小数点的，展示的时候确实是有小数点，回显也没问题，输入时也正确提示！功能开发完毕！

> 设置了公共方法在 utiles 

```javascript
// 加上小数点的操作
export function formatCoord(data) {
    return `${data / 1e7}`;
}
// 去掉小数点的操作
export function reFormatCoord(data) {
    return `${data * 1e7}`;
}
// 验证设备经纬度格式
export const lonValid = (rule, value, callback) => {
    if (value == 0) {// 因为项目不太规范，所以不使用三等号，有的地方是字符串有的地方是数字
        //为 0 的情况不需要考虑小数点
        callback();
    }
    const data = value.toString().split('.');
    if (!data[1] || data[1].length != 7) {
        callback(new Error('请确保经度在 0-180 之间并以 7 位小数结尾'));
        return;
    }
    if (value >= 0 && value <= 180) {
        callback();
    } else {
        callback(new Error('请确保经度在 0-180 之间'));
    }
};
export const latValid = (rule, value, callback) => {
    if (value == 0) {
        //为 0 的情况不需要考虑小数点
        callback();
    }
    const data = value.toString().split('.');
    if (!data[1] || data[1].length != 7) {
        callback(new Error('请确保经度在 0-90 之间并以 7 位小数结尾'));
        return;
    }
    if (value >= 0 && value <= 90) {
        callback();
    } else {
        callback(new Error('请确保经度在 0-90 之间'));
    }
};
```

